<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" name="theme-color" content="#FFD700"/>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Agendamento - App Demonstração</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <link rel="manifest" href="manifest.json" />
  <style>
/* Reset e base */
    *, *::before, *::after {
      box-sizing: border-box;
    }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #121212;
      color: #fff;
      margin: 0; padding: 0;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding-bottom: 40px;
    }
    header {
      text-align:center;
      background: #000;
      padding: 20px;
      width: 100%;
      max-width: 480px;
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 16px;
      font-weight: 300;
      color: #FFD700;
      letter-spacing: 2px;
      user-select: none;
      box-shadow: 0 2px 8px rgba(255, 215, 0, 0.5);
      border-radius: 8px;
    }
    #logo {
      border-radius:50%;
      width: 40px;
      height: 40px;
      object-fit: contain;
    }
    main.container {
      width: 100%;
      max-width: 480px;
      padding: 20px;
      background: #1f1f1f;
      border-radius: 12px;
      margin-top: 20px;
      box-shadow: 0 0 15px #FFD700aa;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    #servicos {
      display: flex;
      flex-direction: column;
      gap: 14px;
      max-height: 320px;
      overflow-y: auto;
      padding-right: 8px;
      outline: none;
    }
    .servico {
      background: #2a2a2a;
      border-radius: 12px;
      padding: 12px;
      display: flex;
      align-items: center;
      cursor: pointer;
      user-select: none;
      border: 2px solid transparent;
      transition: background-color 0.3s, border-color 0.3s;
    }
    .servico:hover {
      background: #393939;
      border-color: #FFD700;
    }
    .servico input[type="radio"] {
      margin-right: 14px;
      accent-color: #FFD700;
      width: 20px;
      height: 20px;
      cursor: pointer;
      flex-shrink: 0;
    }
    .servico img {
      width: 70px;
      height: 70px;
      border-radius: 10px;
      object-fit: cover;
      margin-right: 14px;
      flex-shrink: 0;
      box-shadow: 0 0 6px #FFD700aa;
      transition: transform 0.3s;
    }
    .servico:hover img {
      transform: scale(1.05);
    }
    .servico div {
      flex: 1;
    }
    .servico strong {
      font-size: 1.1rem;
      margin-bottom: 6px;
      display: block;
    }
    .servico small {
      font-size: 0.85rem;
      color: #ccc;
    }
    .form-group {
      display: flex;
      flex-direction: column;
    }
    label {
      margin-bottom: 6px;
      font-weight: 600;
    }
    input[type="text"],
    input[type="date"],
    select {
      background-color: #2a2a2a;
      border: none;
      border-radius: 8px;
      color: #fff;
      font-size: 1rem;
      padding: 12px 16px;
      transition: box-shadow 0.3s ease, background-color 0.3s ease;
    }
    input[type="text"]:focus,
    input[type="date"]:focus,
    select:focus {
      outline: none;
      box-shadow: 0 0 8px #FFD700;
      background-color: #3b3b3b;
    }
    select {
      appearance: none;
      -webkit-appearance: none;
      background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20width%3D'12'%20height%3D'12'%20viewBox%3D'0%200%2012%2012'%20xmlns%3D'http%3A//www.w3.org/2000/svg'%3E%3Cpath%20d%3D'M2%204l4%204%204-4'%20stroke%3D'%23FFD700'%20stroke-width%3D'2'%20fill%3D'none'%20fill-rule%3D'evenodd'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 12px center;
      background-size: 12px 12px;
      padding-right: 36px;
      cursor: pointer;
    }
    button {
      width:100%;
      background-color: #FFD700;
      border: none;
      border-radius: 10px;
      font-weight: 900;
      color: #121212;
      font-size: 1.2rem;
      padding: 14px;
      cursor: pointer;
      transition: background-color 0.3s ease, box-shadow 0.3s ease;
      box-shadow: 0 4px 12px #FFD700cc;
      user-select: none;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    button:hover:not(:disabled) {
      background-color: #e6c200;
      box-shadow: 0 6px 14px #e6c200cc;
    }
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      box-shadow: none;
    }
    .spinner {
      border: 4px solid #2a2a2a;
      border-top: 4px solid #FFD700;
      border-radius: 50%;
      width: 26px;
      height: 26px;
      animation: spin 1s linear infinite;
      display: inline-block;
      vertical-align: middle;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    #msgStatus {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: #272727dd;
      color: #FFD700;
      padding: 12px 24px;
      border-radius: 24px;
      font-weight: 700;
      font-size: 1rem;
      box-shadow: 0 0 12px #FFD700cc;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
      z-index: 9999;
    }
    #msgStatus.show {
      opacity: 1;
      pointer-events: auto;
    }
    @media (max-width: 520px) {
      header {
        font-size: 1.5rem;
        padding: 16px;
      }
      main.container {
        padding: 16px;
      }
      .servico img {
        width: 55px;
        height: 55px;
      }
      button {
  font-size: 1rem;
  padding: 10px;
}

    }


    /* Tela de carregamento (splash) */
    #splash {
      position: fixed;
      inset: 0;
      background-color: #121212;
      color: #FFD700;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 10000;
      user-select: none;
    }
    #splash img {
      border-radius: 50%;
      width: 220px;
      height: auto;
      margin-bottom: 20px;
      filter: drop-shadow(0 0 5px #FFD700);
    }
    #splash h1 {
      font-size: 2.5rem;
      font-weight: 100;
      letter-spacing: 3px;
      margin-bottom: 30px;
      text-align: center;
      text-shadow: 0 0 10px #FFD700;
    }
    #progressBarContainer {
      width: 70%;
      max-width: 400px;
      height: 14px;
      background-color: #2a2a2a;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 0 10px #FFD700cc inset;
    }
    #progressBar {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, #FFD700, #e6c200);
      border-radius: 10px;
      transition: width 0.1s ease;
      box-shadow: 0 0 8px #FFD700;
    }
    .titulo{
      font-size:16px;
    }
}

    #toggleMenu {
  font-size: 5px;
  margin-left: auto;
  cursor: pointer;
  color: #FFD700;
}

#menuHistorico {
  position: fixed;
  top: 80px;
  left: 0;
  width: 280px;
  height: calc(100vh - 80px);
  background: #000;
  color: #fff;
  box-shadow: 2px 0 10px #FFD70055;
  padding: 20px;
  overflow-y: auto;
  transform: translateX(-100%);
  transition: transform 0.3s ease;
  z-index: 2000;
  border-radius: 20px;
}

#menuHistorico.open {
  transform: translateX(0);
}

#menuHistorico h3 {
  color: #FFD700;
  margin-bottom: 20px;
}

    
  </style>
</head>
<body>
  <div id="splash">
    <img src="logo.png" alt="Logo da Barbearia" />
    <h1>Demonstração Premium</h1>
    <div id="progressBarContainer">
      <div id="progressBar"></div>
    </div>
    <p>www.atecseven.com.br</p>
  </div>

  <header><img src="logo.png" alt="Logo da Barbearia" id="logo" />
    <span id="toggleMenu"><i class="fa-solid fa-clock-rotate-left"></i></span>
    <div id="menuHistorico"></div>
    <h1 class="titulo">Demonstração Premium</h1>
  </header>
  
  <main class="container" style="display:none;">
    <form id="formAgendamento" novalidate>
      <div id="servicos"></div>

      <!-- NOVO: container para lista de barbeiros -->
      <div id="barbeiros" style="margin-bottom: 1rem;">
        <h3>Escolha o Barbeiro</h3>
        <!-- Radios serão carregados via JS -->
      </div>

      <div class="form-group">
        <label for="nome">Seu nome:</label>
        <input type="text" id="nome" name="nome" placeholder="Digite seu nome completo" required minlength="3" />
      </div>

      <div class="form-group">
        <label for="whatsapp">WhatsApp:</label>
        <input type="text" id="whatsapp" name="whatsapp" placeholder="Digite seu número de WhatsApp" />
      </div>

      <div class="form-group">
        <label for="dataAgendamento">Data do agendamento:</label>
        <input type="date" id="dataAgendamento" name="dataAgendamento" required />
      </div>

      <div class="form-group">
        <label for="horaAgendamento">Horário disponível:</label>
        <select id="horaAgendamento" name="horaAgendamento" required>
          <option value="">Selecione uma data primeiro</option>
        </select>
      </div>
      <br><br>
      <button type="submit" id="btnAgendar">Agendar <i class="fa-solid fa-calendar-check"></i></button>
    </form>
  </main>
  
  <br><br>
  
  <div id="installPrompt" style="display: none; position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
  background: #FFD700; color: #121212; padding: 12px 20px; border-radius: 30px;
  font-weight: bold; box-shadow: 0 0 10px #FFD700aa; z-index: 9999; cursor: pointer;">
    Instale o noss app no seu celular 📲
  </div>

  <div id="msgStatus"></div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.5.2/firebase-app.js";
  import { getDatabase, ref, push, onValue } from "https://www.gstatic.com/firebasejs/10.5.2/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAbUILxEOHP4Vg18Qw-YpCnoh41kOGwLk0",
    authDomain: "fir-barber-premium.firebaseapp.com",
    databaseURL: "https://fir-barber-premium-default-rtdb.firebaseio.com/",
    projectId: "fir-barber-premium",
  storageBucket: "fir-barber-premium.firebasestorage.app",
  messagingSenderId: "35107383104",
  appId: "1:35107383104:web:993f10c7d0163f06f23ca5",
  measurementId: "G-5DTQQX4T3R"
};

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  const servicosDiv = document.getElementById("servicos");
  const barbeirosDiv = document.getElementById("barbeiros");
  const form = document.getElementById("formAgendamento");
  const btnAgendar = document.getElementById("btnAgendar");
  const msgStatus = document.getElementById("msgStatus");
  const campoData = document.getElementById("dataAgendamento");
  const campoHora = document.getElementById("horaAgendamento");

  let servicosDados = {};
  let barbeirosDados = {};

  function showMessage(msg, isError = false) {
    msgStatus.textContent = msg;
    msgStatus.style.backgroundColor = isError ? '#7a1e1edd' : '#272727dd';
    msgStatus.classList.add('show');
    setTimeout(() => msgStatus.classList.remove('show'), 4000);
  }

  function gerarTodosHorarios() {
    const horarios = [];
    const inicio = new Date(); inicio.setHours(9, 0, 0, 0);
    const fim = new Date(); fim.setHours(21, 0, 0, 0);
    let atual = new Date(inicio);
    while (atual < fim) {
      const h = atual.getHours().toString().padStart(2, '0');
      const m = atual.getMinutes().toString().padStart(2, '0');
      horarios.push(`${h}:${m}`);
      atual = new Date(atual.getTime() + 10 * 60000);
    }
    return horarios;
  }

  function validarHorario(horarioISO) {
    if (!horarioISO || !horarioISO.includes('T')) return false;
    const [dataStr, horaStr] = horarioISO.split('T');
    if (!dataStr || !horaStr) return false;
    const [ano, mes, dia] = dataStr.split('-').map(Number);
    const [hora, minuto] = horaStr.split(':').map(Number);
    const agendamento = new Date(ano, mes - 1, dia, hora, minuto);
    const agora = new Date();
    if (isNaN(agendamento.getTime())) return false;
    if (agendamento <= agora) return false;
    const horarioValido = (hora > 9 || (hora === 9 && minuto >= 0)) &&
                          (hora < 21 || (hora === 21 && minuto === 0));
    return horarioValido;
  }

  function atualizarHorariosDisponiveis(dataISO) {
    campoHora.innerHTML = '<option value="">Carregando...</option>';
    const servicoInput = form.querySelector('input[name="servico"]:checked');
    if (!servicoInput) {
      campoHora.innerHTML = '<option value="">Selecione um serviço primeiro</option>';
      return;
    }
    const duracao = Number(servicosDados[servicoInput.value]?.tempo) || 0;

    const barbeiroInput = form.querySelector('input[name="barbeiro"]:checked');
    const barbeiroEscolhido = barbeiroInput ? barbeiroInput.value : 'todos';

    const todos = gerarTodosHorarios();

    onValue(ref(db, 'agendamentos'), snapshot => {
      const ocupados = [];
      snapshot.forEach(child => {
        const ag = child.val();
        const dataAg = new Date(ag.horario);
        if (dataAg.toISOString().split('T')[0] === dataISO) {
          // Filtra agendamentos do barbeiro escolhido ou todos
          if (barbeiroEscolhido === 'todos' || ag.barbeiroId === barbeiroEscolhido) {
            const tempo = Number(servicosDados[ag.servicoId]?.tempo) || 0;
            ocupados.push({ start: dataAg.getTime(), end: dataAg.getTime() + tempo * 60000 });
          }
        }
      });

      const disponiveis = todos.filter(horario => {
        const [h, m] = horario.split(':');
        const inicio = new Date(`${dataISO}T${h}:${m}:00`);
        const fim = new Date(inicio.getTime() + duracao * 60000);

        if (fim.getHours() > 21 || (fim.getHours() === 21 && fim.getMinutes() > 0)) return false;

        return !ocupados.some(o => (inicio < o.end && fim > o.start));
      });

      campoHora.innerHTML = disponiveis.length
        ? '<option value="">Selecione um horário</option>' + disponiveis.map(h => `<option value="${h}">${h}</option>`).join('')
        : '<option value="">Sem horários disponíveis</option>';
    }, { onlyOnce: true });
  }

  campoData.addEventListener('change', () => {
    if (campoData.value) atualizarHorariosDisponiveis(campoData.value);
  });

  // Atualiza horários também ao mudar barbeiro ou serviço
  barbeirosDiv.addEventListener('change', () => {
    if (campoData.value) atualizarHorariosDisponiveis(campoData.value);
  });
  servicosDiv.addEventListener('change', () => {
    if (campoData.value) atualizarHorariosDisponiveis(campoData.value);
  });

  async function fetchServicos() {
    onValue(ref(db, 'servicos'), snapshot => {
      servicosDiv.innerHTML = '';
      servicosDados = {};
      snapshot.forEach(child => {
        const serv = child.val();
        servicosDados[child.key] = serv;
        const label = document.createElement('label'); label.className = 'servico';
        const input = document.createElement('input');
        input.type = 'radio'; input.name = 'servico'; input.value = child.key; input.required = true;
        input.addEventListener('change', () => { if (campoData.value) atualizarHorariosDisponiveis(campoData.value); });
        const img = document.createElement('img'); img.src = serv.imagem; img.alt = serv.nome;
        const div = document.createElement('div');
        const strong = document.createElement('strong'); strong.textContent = serv.nome;
        const small = document.createElement('small'); small.textContent = `R$ ${serv.preco} - ${serv.tempo} min`;
        div.appendChild(strong); div.appendChild(small);
        label.appendChild(input); label.appendChild(img); label.appendChild(div);
        servicosDiv.appendChild(label);
      });
    }, { onlyOnce: true });
  }

  async function fetchBarbeiros() {
    onValue(ref(db, 'barbeiros'), snapshot => {
      barbeirosDiv.innerHTML = '<h3>Escolha o Barbeiro</h3>';

      const labelTodos = document.createElement('label');
      labelTodos.innerHTML = `<input type="radio" name="barbeiro" value="todos" checked> Qualquer Barbeiro`;
      barbeirosDiv.appendChild(labelTodos);

      barbeirosDados = {};
      snapshot.forEach(child => {
        barbeirosDados[child.key] = child.val();
        const label = document.createElement('label');
        label.innerHTML = `<input type="radio" name="barbeiro" value="${child.key}"> ${child.val().nome}`;
        barbeirosDiv.appendChild(label);
      });
    }, { onlyOnce: true });
  }

  // ------------------ Adicionado: função registrarNotificacao ------------------
  async function registrarNotificacao(tipo, dados = {}) {
    await push(ref(db, 'notificacoes'), {
      id: Math.random().toString(36).substr(2,10),
      tipo,
      timestamp: new Date().toISOString(),
      ...dados
    });
  }
  window.registrarNotificacao = registrarNotificacao;
  // ------------------------------------------------------------------------------

  form.addEventListener('submit', async e => {
    e.preventDefault();
    const nome = form.nome.value.trim();
    const whatsapp = form.whatsapp.value.trim();
    const data = campoData.value;
    const hora = campoHora.value;
    const servicoInput = form.querySelector('input[name="servico"]:checked');
    const barbeiroInput = form.querySelector('input[name="barbeiro"]:checked');
    const barbeiroId = barbeiroInput ? barbeiroInput.value : 'todos';
    const horario = `${data}T${hora}:00`;

    if (!nome || nome.length < 3 || !validarHorario(horario) || !servicoInput || !hora) {
      showMessage('Provavelmente já passou desse horário🤔⏱.', true);
      return;
    }
    btnAgendar.disabled = true;
    btnAgendar.innerHTML = 'Agendando...';

    try {
      await push(ref(db, 'agendamentos'), {
        nome,
        whatsapp,
        horario,
        servicoId: servicoInput.value,
        barbeiroId,
        status: 'Agendado',
        criadoEm: new Date().toISOString()
      });
      showMessage('Agendamento realizado com sucesso!');
      form.reset();
      await salvarNoHistorico({ nome, horario });
      campoHora.innerHTML = '<option value="">Selecione uma data primeiro</option>';
    } catch (err) {
      showMessage('Erro ao agendar: ' + err.message, true);
    } finally {
      btnAgendar.disabled = false;
      btnAgendar.innerHTML = 'Agendar <i class="fa-solid fa-calendar-check"></i>';
    }
  });

  function initSplash() {
    const splash = document.getElementById('splash');
    const progressBar = document.getElementById('progressBar');
    const container = document.querySelector('main.container');
    let start = null;
    function step(timestamp) {
      if (!start) start = timestamp;
      const elapsed = timestamp - start;
      const progress = Math.min((elapsed / 3000) * 100, 100);
      progressBar.style.width = progress + '%';
      if (elapsed < 3000) requestAnimationFrame(step);
      else {
        splash.style.display = 'none';
        container.style.display = 'flex';
      }
    }
    requestAnimationFrame(step);
  }

  fetchServicos();
  fetchBarbeiros();
  initSplash();
</script>

<script>
  const toggleMenu = document.getElementById('toggleMenu');
  const menuHistorico = document.getElementById('menuHistorico');

  toggleMenu.addEventListener('click', () => {
    menuHistorico.classList.toggle('open');
    document.addEventListener('click', e => {
      const clicouForaDoMenu = !menuHistorico.contains(e.target) && !toggleMenu.contains(e.target);
      if (menuHistorico.classList.contains('open') && clicouForaDoMenu) {
        menuHistorico.classList.remove('open');
      }
    });
  });

  const formatarDataHora = iso => {
    const d = new Date(iso);
    return d.toLocaleDateString('pt-BR') + ' ' +
           d.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
  };

  const renderizarHistorico = () => {
    const historico = JSON.parse(localStorage.getItem('historicoAgendamentos')) || [];
    menuHistorico.innerHTML = '<h3>Histórico de Agendamentos</h3>';
    historico.slice(0, 5).forEach((agendamento, index) => {
      const div = document.createElement('div');
      div.style.marginBottom = '16px';
      div.style.padding = '10px';
      div.style.background = '#1f1f1f';
      div.style.borderRadius = '8px';
      div.innerHTML = `
        <strong>${agendamento.nome}</strong><br>
        <small>${formatarDataHora(agendamento.horario)}</small>
      `;
      if (index === 0) {
        const btnCancelar = document.createElement('button');
        btnCancelar.textContent = 'Solicitar Cancelamento';
        btnCancelar.style.marginTop = '8px';
        btnCancelar.onclick = () => {
          const msg = `Olá, gostaria de cancelar o agendamento de ${agendamento.nome} marcado para ${formatarDataHora(agendamento.horario)}.`;
          window.open(`https://wa.me/5564992952748?text=${encodeURIComponent(msg)}`, '_blank');
          window.registrarNotificacao('cancelamento', { nome: agendamento.nome, horario: agendamento.horario });
        };

        const btnEspera = document.createElement('button');
        btnEspera.textContent = 'Pedir +5 min';
        btnEspera.style.marginTop = '6px';
        btnEspera.onclick = () => {
          const msg = `Olá, gostaria de solicitar um acréscimo de 5 minutos para o agendamento de ${agendamento.nome} marcado para ${formatarDataHora(agendamento.horario)}.`;
          window.open(`https://wa.me/5564992952748?text=${encodeURIComponent(msg)}`, '_blank');
          window.registrarNotificacao('pedir_mais_5min', { nome: agendamento.nome, horario: agendamento.horario });
        };

        div.appendChild(btnCancelar);
        div.appendChild(btnEspera);
      }
      menuHistorico.appendChild(div);
    });
  };

  async function salvarNoHistorico(agendamento) {
    const historico = JSON.parse(localStorage.getItem('historicoAgendamentos')) || [];
    historico.unshift(agendamento);
    localStorage.setItem('historicoAgendamentos', JSON.stringify(historico.slice(0, 5)));
    renderizarHistorico();
  }

  renderizarHistorico();
</script>

<script>
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('./sw.js')
        .then(reg => console.log('Service Worker registrado!', reg.scope))
        .catch(err => console.error('Erro ao registrar o Service Worker', err));
    });
  }
</script>

<script>
  let deferredPrompt;
  const installPrompt = document.getElementById('installPrompt');

  window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    deferredPrompt = e;
    installPrompt.style.display = 'block';
  });

  installPrompt.addEventListener('click', async () => {
    installPrompt.style.display = 'none';
    if (deferredPrompt) {
      deferredPrompt.prompt();
      const { outcome } = await deferredPrompt.userChoice;
      if (outcome === 'accepted') {
        console.log('Usuário aceitou instalar');
      } else {
        console.log('Usuário recusou instalar');
      }
      deferredPrompt = null;
    }
  });

  window.addEventListener('appinstalled', () => {
    console.log('App instalado');
    installPrompt.style.display = 'none';
  });
</script>
</body>
</html>
